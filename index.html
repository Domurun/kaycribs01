<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KayCribs | Verified Real Estate & Legal Services</title>
    <meta name="description" content="Securely buy, sell, rent and manage property in Rivers State with legal backing.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts: Poppins (Headers) & Inter (Body) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-green: #16a34a; /* green-600 */
            --dark-green: #15803d; /* green-700 */
        }
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, h5, h6, .font-heading { font-family: 'Poppins', sans-serif; }
        
        /* Smooth modal transitions */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Page Transitions */
        .page-view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #16a34a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #15803d; }
        
        /* Active Nav Link */
        .nav-link.active {
            color: #16a34a;
            font-weight: 600;
        }

        /* Auth Toggle Switch */
        .auth-toggle {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.25rem;
            display: flex;
            margin-bottom: 1.5rem;
        }
        .auth-toggle-btn {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .auth-toggle-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #16a34a;
        }
        .auth-toggle-btn.inactive {
            color: #6b7280;
            background: transparent;
        }

        /* Chat Styles */
        .chat-sidebar-item.active {
            background-color: #f0fdf4;
            border-left: 4px solid #16a34a;
        }
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            position: relative;
        }
        .message-sent {
            background-color: #16a34a;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .message-received {
            background-color: #f3f4f6;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- Logo -->
            <a href="#" onclick="router.navigate('home')" class="flex items-center gap-2 group cursor-pointer">
                <div class="bg-green-600 text-white p-2 rounded-lg group-hover:bg-green-700 transition-colors">
                    <i data-lucide="home" class="w-6 h-6"></i>
                </div>
                <span class="font-heading font-bold text-2xl text-gray-900 tracking-tight">Kay<span class="text-green-600">Cribs</span></span>
            </a>

            <!-- Desktop Menu -->
            <div class="hidden md:flex items-center gap-8">
                <a href="#" onclick="router.navigate('home')" class="nav-link text-sm font-medium text-gray-600 hover:text-green-600 transition-colors" data-page="home">Home</a>
                <a href="#" onclick="router.navigate('marketplace')" class="nav-link text-sm font-medium text-gray-600 hover:text-green-600 transition-colors" data-page="marketplace">Marketplace</a>
                <a href="#" onclick="router.navigate('legal')" class="nav-link text-sm font-medium text-gray-600 hover:text-green-600 transition-colors" data-page="legal">Legal Services</a>
                <a href="#" onclick="router.navigate('agents')" class="nav-link text-sm font-medium text-gray-600 hover:text-green-600 transition-colors" data-page="agents">Agents</a>
            </div>

            <!-- Auth Buttons (Dynamic) -->
            <div class="hidden md:flex items-center gap-4" id="auth-buttons-desktop">
                <!-- Injected via JS -->
            </div>

            <!-- Mobile Menu Button -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-gray-600 focus:outline-none">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 absolute w-full left-0 shadow-xl top-[72px]">
            <div class="flex flex-col p-6 space-y-4">
                <a href="#" onclick="router.navigate('home'); toggleMobileMenu()" class="text-gray-700 font-medium hover:text-green-600">Home</a>
                <a href="#" onclick="router.navigate('marketplace'); toggleMobileMenu()" class="text-gray-700 font-medium hover:text-green-600">Marketplace</a>
                <a href="#" onclick="router.navigate('legal'); toggleMobileMenu()" class="text-gray-700 font-medium hover:text-green-600">Legal Services</a>
                <a href="#" onclick="router.navigate('agents'); toggleMobileMenu()" class="text-gray-700 font-medium hover:text-green-600">Agents</a>
                <a href="#" onclick="router.navigate('chat'); toggleMobileMenu()" class="text-gray-700 font-medium hover:text-green-600 hidden mobile-chat-link">Messages</a>
                <div id="auth-buttons-mobile" class="flex flex-col gap-3 pt-4 border-t border-gray-100">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow pt-[72px]">
        
        <!-- PAGE: HOME -->
        <div id="view-home" class="page-view active">
            <!-- Hero Section -->
            <header class="relative pt-20 pb-20 lg:pt-32 lg:pb-32 overflow-hidden min-h-[600px] flex items-center">
                <!-- Background Image -->
                <div class="absolute inset-0 z-0">
                    <img src="https://images.unsplash.com/photo-1600596542815-e32c0ee3253f?q=80&w=2000&auto=format&fit=crop" class="w-full h-full object-cover" alt="Modern House">
                    <div class="absolute inset-0 bg-gradient-to-r from-gray-900/90 to-gray-900/40"></div>
                </div>

                <div class="container mx-auto px-6 relative z-10">
                    <div class="max-w-2xl">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/20 border border-green-500/30 backdrop-blur-md mb-6">
                            <span class="flex h-2 w-2 rounded-full bg-green-400"></span>
                            <span class="text-xs font-semibold text-green-100 uppercase tracking-wide">Verified Listings Only</span>
                        </div>
                        <h1 class="font-heading text-5xl md:text-6xl font-bold text-white leading-tight mb-6">
                            Find Your Perfect <br/>
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600">Sanctuary</span> in Rivers.
                        </h1>
                        <p class="text-lg text-gray-300 mb-8 font-light leading-relaxed">
                            The safest way to buy, sell, and rent properties. We combine premium real estate listings with integrated legal protection.
                        </p>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="router.navigate('marketplace')" class="px-8 py-4 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-all shadow-lg shadow-green-600/30 flex justify-center items-center gap-2">
                                Browse Properties <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                            <button onclick="toggleAuthModal('buyer')" class="px-8 py-4 bg-white/10 backdrop-blur-md text-white border border-white/20 font-semibold rounded-xl hover:bg-white hover:text-green-900 transition-all flex justify-center items-center gap-2 hero-auth-btn">
                                Create Account
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Featured Section (Teaser for Marketplace) -->
            <section class="py-16 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center max-w-2xl mx-auto mb-12">
                        <h2 class="font-heading text-3xl font-bold text-gray-900 mb-4">Latest Properties</h2>
                        <p class="text-gray-600">A sneak peek at our most exclusive and verified listings available right now.</p>
                    </div>
                    <div id="home-featured-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                        <!-- Populated via JS (Limited to 3) -->
                    </div>
                    <div class="text-center">
                        <button onclick="router.navigate('marketplace')" class="inline-flex items-center gap-2 text-green-600 font-semibold hover:text-green-700">
                            View All Listings <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- PAGE: MARKETPLACE -->
        <div id="view-marketplace" class="page-view">
            <section class="bg-gray-900 py-12">
                <div class="container mx-auto px-6">
                    <h1 class="font-heading text-4xl font-bold text-white mb-4">Marketplace</h1>
                    <p class="text-gray-400">Explore verified properties available for rent, lease, or sale across Port Harcourt.</p>
                </div>
            </section>
            
            <section class="py-12 bg-gray-50">
                <div class="container mx-auto px-6">
                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-2" id="marketplace-filters">
                            <button onclick="filterMarketplace('all')" class="filter-btn px-4 py-2 text-sm font-medium bg-green-100 text-green-700 rounded-md transition-colors hover:bg-green-200 active" data-filter="all">All</button>
                            <button onclick="filterMarketplace('For Sale')" class="filter-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors" data-filter="For Sale">For Sale</button>
                            <button onclick="filterMarketplace('For Rent')" class="filter-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors" data-filter="For Rent">For Rent</button>
                            <button onclick="filterMarketplace('For Lease')" class="filter-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors" data-filter="For Lease">For Lease</button>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto relative">
                            <input type="text" id="marketplace-search" oninput="searchMarketplace(this.value)" placeholder="Search location or title..." class="px-4 py-2 pl-10 border border-gray-200 rounded-lg text-sm w-full md:w-64 focus:outline-none focus:border-green-500">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-3"></i>
                        </div>
                    </div>

                    <!-- Full Grid -->
                    <div id="marketplace-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </section>
        </div>

        <!-- PAGE: LEGAL -->
        <div id="view-legal" class="page-view">
            <section class="bg-green-900 py-12 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="container mx-auto px-6 relative z-10">
                    <h1 class="font-heading text-4xl font-bold text-white mb-4">Legal Services</h1>
                    <p class="text-green-100">Professional legal backing for every real estate transaction.</p>
                </div>
            </section>

            <section class="py-16 bg-white">
                <div class="container mx-auto px-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                        <div>
                            <div class="inline-flex items-center gap-2 text-green-600 font-bold tracking-wide uppercase text-xs mb-4">
                                <i data-lucide="scale" class="w-4 h-4"></i> Why choose KayCribs?
                            </div>
                            <h2 class="font-heading text-3xl md:text-4xl font-bold text-gray-900 mb-6">Property transactions without the risk.</h2>
                            <p class="text-gray-600 text-lg mb-8 leading-relaxed">
                                Unlike standard agencies, KayCribs integrates legal verification into every step. Our in-house legal team ensures titles are clean, contracts are fair, and your investment is secure from fraud.
                            </p>
                            
                            <div class="space-y-6">
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                    <div class="bg-green-100 p-3 h-fit rounded-lg text-green-600"><i data-lucide="file-check" class="w-6 h-6"></i></div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 text-lg">Tenancy Agreements</h4>
                                        <p class="text-sm text-gray-500 mt-1">We draft and review watertight contracts that protect both landlords and tenants.</p>
                                    </div>
                                </div>
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                    <div class="bg-green-100 p-3 h-fit rounded-lg text-green-600"><i data-lucide="search-check" class="w-6 h-6"></i></div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 text-lg">Title Verification</h4>
                                        <p class="text-sm text-gray-500 mt-1">Comprehensive background checks at the lands registry to ensure property legitimacy.</p>
                                    </div>
                                </div>
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                    <div class="bg-green-100 p-3 h-fit rounded-lg text-green-600"><i data-lucide="gavel" class="w-6 h-6"></i></div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 text-lg">Dispute Resolution</h4>
                                        <p class="text-sm text-gray-500 mt-1">Issuance of statutory notices, mediation, and court representation if necessary.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative h-full min-h-[500px]">
                            <img src="https://images.unsplash.com/photo-1589829085413-56de8ae18c73?q=80&w=2000&auto=format&fit=crop" alt="Legal documents" class="rounded-2xl shadow-2xl z-10 w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- PAGE: AGENTS -->
        <div id="view-agents" class="page-view">
             <section class="bg-gray-50 py-12">
                <div class="container mx-auto px-6">
                    <h1 class="font-heading text-4xl font-bold text-gray-900 mb-4">Our Agents</h1>
                    <p class="text-gray-600">Meet the certified professionals connecting you to your dream property.</p>
                </div>
            </section>
            <section class="py-16 bg-white">
                <div class="container mx-auto px-6 text-center">
                    <div class="bg-green-50 rounded-2xl p-12 inline-block">
                        <i data-lucide="users" class="w-16 h-16 text-green-600 mx-auto mb-4"></i>
                        <h3 class="font-heading text-2xl font-bold text-gray-900 mb-2">Agent Directory Coming Soon</h3>
                        <p class="text-gray-600">We are currently vetting our list of top-tier agents in Rivers State.</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- PAGE: CHAT (New) -->
        <div id="view-chat" class="page-view">
            <div class="flex h-[calc(100vh-72px)] bg-gray-50 overflow-hidden">
                <!-- Chat Sidebar -->
                <div class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="font-heading font-bold text-xl text-gray-900">Messages</h2>
                    </div>
                    <div id="chat-list" class="flex-grow overflow-y-auto">
                        <!-- Chat Items Injected Here -->
                    </div>
                </div>

                <!-- Chat Main Area -->
                <div class="hidden md:flex flex-1 flex-col h-full bg-gray-100" id="chat-main">
                    <div id="chat-header" class="bg-white p-4 border-b border-gray-200 flex items-center gap-3 shadow-sm">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500" id="chat-header-avatar">?</div>
                        <div>
                            <h3 class="font-bold text-gray-900" id="chat-header-name">Select a conversation</h3>
                            <p class="text-xs text-gray-500" id="chat-header-status"></p>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-6 space-y-4">
                        <!-- Messages Injected Here -->
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <p>Select a chat from the sidebar to start messaging.</p>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-gray-200 hidden" id="chat-input-area">
                        <form onsubmit="handleSendMessage(event)" class="flex gap-2">
                            <input type="text" id="message-input" class="flex-grow px-4 py-3 bg-gray-100 border border-transparent rounded-xl focus:bg-white focus:border-green-500 focus:outline-none transition-all" placeholder="Type a message...">
                            <button type="submit" class="bg-green-600 text-white p-3 rounded-xl hover:bg-green-700 transition-colors shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: DASHBOARD (Protected) -->
        <div id="view-dashboard" class="page-view">
            <section class="bg-gray-900 py-8 border-b border-gray-800">
                <div class="container mx-auto px-6 flex justify-between items-center">
                    <div>
                        <h1 class="font-heading text-2xl font-bold text-white mb-1">My Dashboard</h1>
                        <p class="text-gray-400 text-sm">Welcome back, <span class="user-name-display text-green-400 font-semibold">User</span></p>
                    </div>
                    <div id="seller-actions" class="hidden">
                        <button onclick="toggleUploadModal()" class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg shadow-green-900/20 text-sm font-medium">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Post Property
                        </button>
                    </div>
                </div>
            </section>
            
            <section class="py-12 bg-gray-50 min-h-[60vh]">
                <div class="container mx-auto px-6">
                    <!-- Dashboard Tabs -->
                    <div class="flex gap-6 border-b border-gray-200 mb-8">
                        <button class="pb-3 border-b-2 border-green-600 text-green-700 font-medium text-sm" id="dashboard-tab-main">My Listings</button>
                        <button class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-800 font-medium text-sm transition-colors">Settings</button>
                    </div>

                    <!-- Listings Content -->
                    <div id="dashboard-listings-container">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </section>
        </div>

    </main>

    <!-- Footer (Shared across all pages) -->
    <footer class="bg-gray-900 text-white pt-16 pb-8 border-t border-gray-800 mt-auto">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-gray-800 pb-12">
                <div class="md:col-span-2">
                    <a href="#" onclick="router.navigate('home')" class="flex items-center gap-2 mb-6">
                        <div class="bg-green-600 text-white p-1.5 rounded">
                            <i data-lucide="home" class="w-5 h-5"></i>
                        </div>
                        <span class="font-heading font-bold text-2xl tracking-tight">KayCribs</span>
                    </a>
                    <p class="text-gray-400 max-w-sm mb-6">
                        Bridging the gap between premium real estate and legal security in Rivers State.
                    </p>
                    <div class="flex gap-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-green-600 transition-colors"><i data-lucide="facebook" class="w-5 h-5"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-green-600 transition-colors"><i data-lucide="twitter" class="w-5 h-5"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-green-600 transition-colors"><i data-lucide="instagram" class="w-5 h-5"></i></a>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-heading font-bold text-lg mb-6">Services</h4>
                    <ul class="space-y-3 text-gray-400">
                        <li><a href="#" onclick="router.navigate('marketplace')" class="hover:text-green-500 transition-colors">Property Sales</a></li>
                        <li><a href="#" onclick="router.navigate('legal')" class="hover:text-green-500 transition-colors">Legal Consultation</a></li>
                        <li><a href="#" onclick="router.navigate('agents')" class="hover:text-green-500 transition-colors">Property Management</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-heading font-bold text-lg mb-6">Contact</h4>
                    <ul class="space-y-4 text-gray-400">
                        <li class="flex items-start gap-3">
                            <i data-lucide="map-pin" class="w-5 h-5 text-green-600 mt-0.5"></i>
                            <span>No. 8 Peace Avenue, Port Harcourt, Rivers State.</span>
                        </li>
                        <li class="flex items-center gap-3">
                            <i data-lucide="phone" class="w-5 h-5 text-green-600"></i>
                            <span>+234 813 501 5451</span>
                        </li>
                        <li class="flex items-center gap-3">
                            <i data-lucide="mail" class="w-5 h-5 text-green-600"></i>
                            <span>hello@kaycribs.com</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="pt-8 text-center text-gray-600 text-sm">
                &copy; 2024 KayCribs Real Estate. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Auth Modal (Login/Signup) -->
    <div id="auth-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative">
            <button onclick="toggleAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <!-- Auth Role Toggle -->
            <div class="px-8 pt-8 pb-0">
                <div class="auth-toggle">
                    <button onclick="setAuthRole('buyer')" id="btn-role-buyer" class="auth-toggle-btn active">I want to Buy/Rent</button>
                    <button onclick="setAuthRole('seller')" id="btn-role-seller" class="auth-toggle-btn inactive">I want to Sell/List</button>
                </div>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="px-8 pb-8 pt-4">
                <h3 class="font-heading text-2xl font-bold text-gray-900 mb-2" id="login-title">Buyer Login</h3>
                <p class="text-gray-500 text-sm mb-6">Sign in to manage your account.</p>
                
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all" placeholder="you@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition-all shadow-lg shadow-green-600/20">Sign In</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Don't have an account? <button onclick="switchAuthMode('signup')" class="text-green-600 font-semibold hover:underline">Create Account</button>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="px-8 pb-8 pt-4 hidden">
                <h3 class="font-heading text-2xl font-bold text-gray-900 mb-2" id="signup-title">Create Buyer Account</h3>
                <p class="text-gray-500 text-sm mb-6">Join KayCribs today.</p>
                
                <form onsubmit="handleSignup(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                            <input type="text" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                            <input type="text" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500">
                    </div>
                    
                    <!-- Security Verification Field (Toggled by Role) -->
                    <div id="id-verification-field" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 uppercase tracking-wide mb-1 flex items-center gap-2">
                            <i data-lucide="shield-check" class="w-3 h-3"></i> Security Verification
                        </label>
                        <p class="text-xs text-blue-600 mb-2">To list properties, please provide a valid ID number (NIN, BVN, or Drivers License).</p>
                        <input type="text" id="signup-id-input" class="w-full px-4 py-2 bg-white border border-blue-200 rounded-md focus:outline-none focus:border-blue-500 text-sm" placeholder="Enter ID Number">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition-all shadow-lg shadow-green-600/20">Verify & Join</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Already have an account? <button onclick="switchAuthMode('login')" class="text-green-600 font-semibold hover:underline">Sign In</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Property Details Modal (New) -->
    <div id="property-details-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row max-h-[90vh]">
            <button onclick="closePropertyDetails()" class="absolute top-4 right-4 z-10 bg-white/80 p-2 rounded-full text-gray-600 hover:text-black hover:bg-white transition-all shadow-sm">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <!-- Image Side -->
            <div class="w-full md:w-1/2 h-64 md:h-auto bg-gray-100 relative">
                <img id="detail-image" src="" class="w-full h-full object-cover">
                <div class="absolute top-4 left-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-gray-900 uppercase tracking-wide" id="detail-type">
                    For Sale
                </div>
            </div>

            <!-- Info Side -->
            <div class="w-full md:w-1/2 p-8 overflow-y-auto">
                <div class="mb-6">
                    <h2 class="font-heading text-2xl md:text-3xl font-bold text-gray-900 mb-2" id="detail-title">Property Title</h2>
                    <div class="flex items-center gap-2 text-gray-500 text-sm mb-4">
                        <i data-lucide="map-pin" class="w-4 h-4 text-green-600"></i>
                        <span id="detail-location">Location</span>
                    </div>
                    <div class="text-3xl font-bold text-green-600 mb-6" id="detail-price">₦0</div>
                    
                    <div class="flex gap-3 mb-6">
                        <button onclick="saveProperty(currentPropertyId)" class="flex-1 border border-gray-200 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2" id="detail-save-btn">
                            <i data-lucide="heart" class="w-5 h-5"></i> Save
                        </button>
                        <button onclick="shareProperty(currentPropertyId)" class="flex-1 border border-gray-200 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="share-2" class="w-5 h-5"></i> Share
                        </button>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Comments Section -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-100">
                        <h4 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                            <i data-lucide="align-left" class="w-4 h-4 text-gray-400"></i> Advertiser's Comments
                        </h4>
                        <p class="text-gray-600 text-sm leading-relaxed" id="detail-desc">
                            No description provided.
                        </p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold text-lg" id="advertiser-avatar">A</div>
                            <div>
                                <p class="text-sm font-bold text-gray-900" id="advertiser-name">Agent Name</p>
                                <p class="text-xs text-green-600 font-semibold">Verified Advertiser</p>
                            </div>
                        </div>
                        
                        <button onclick="startChat()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl hover:bg-gray-800 transition-all shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="message-circle" class="w-5 h-5"></i> Chat with Advertiser
                        </button>
                        <p class="text-center text-xs text-gray-400 mt-3 flex items-center justify-center gap-1">
                            <i data-lucide="shield" class="w-3 h-3"></i> Secure KayCribs Messaging
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Property Modal -->
    <div id="upload-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-heading text-xl font-bold text-gray-900">List Your Property</h3>
                <button onclick="toggleUploadModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="p-8 overflow-y-auto">
                <form onsubmit="handlePropertyUpload(event)" class="space-y-6">
                    <!-- Image Upload -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property Image</label>
                        <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors group">
                            <input type="file" id="property-image" accept="image/*" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)">
                            <div id="image-preview-container" class="flex flex-col items-center justify-center">
                                <i data-lucide="image-plus" class="w-10 h-10 text-gray-400 group-hover:text-green-500 mb-2 transition-colors"></i>
                                <p class="text-sm text-gray-500"><span class="text-green-600 font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-400 mt-1">SVG, PNG, JPG or GIF (MAX. 5MB)</p>
                            </div>
                            <img id="image-preview" src="#" alt="Preview" class="hidden max-h-48 mx-auto rounded-lg shadow-sm object-cover">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Property Title</label>
                            <input type="text" id="prop-title" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500" placeholder="e.g. 3 Bedroom Duplex">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price (NGN)</label>
                            <input type="number" id="prop-price" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500" placeholder="e.g. 5000000">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <input type="text" id="prop-location" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500" placeholder="e.g. GRA Phase 2, PH">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="prop-type" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500">
                                <option value="For Sale">For Sale</option>
                                <option value="For Rent">For Rent</option>
                                <option value="For Lease">For Lease</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description & Key Features</label>
                        <textarea id="prop-desc" rows="3" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:border-green-500" placeholder="Describe the property..."></textarea>
                    </div>

                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 transition-all shadow-lg shadow-green-600/20">Publish Listing</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. Router & State ---
        const router = {
            currentPage: 'home',
            navigate: function(pageId) {
                // Check auth for protected routes
                if ((pageId === 'dashboard' || pageId === 'chat') && !appState.isLoggedIn) {
                    toggleAuthModal();
                    return;
                }

                // Hide all views
                document.querySelectorAll('.page-view').forEach(view => {
                    view.classList.remove('active');
                });

                // Show target view
                const target = document.getElementById(`view-${pageId}`);
                if (target) {
                    target.classList.add('active');
                    this.currentPage = pageId;
                    
                    // Update Nav Links Active State
                    document.querySelectorAll('.nav-link').forEach(link => {
                        if (link.dataset.page === pageId) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });

                    // View specific logic
                    if(pageId === 'home') renderHomeListings();
                    if(pageId === 'marketplace') renderMarketplaceListings();
                    if(pageId === 'dashboard') renderDashboardListings();
                    if(pageId === 'chat') renderChatList();

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        };

        // --- 2. App State ---
        let currentAuthRole = 'buyer'; // 'buyer' or 'seller'
        let currentPropertyId = null; // Track currently open property detail
        let activeChatId = null;

        const appState = {
            isLoggedIn: localStorage.getItem('kaycribs_logged_in') === 'true',
            user: JSON.parse(localStorage.getItem('kaycribs_user')) || null,
            savedListings: JSON.parse(localStorage.getItem('kaycribs_saved')) || [],
            listings: [
                {
                    id: 1,
                    title: "Modern 4 Bedroom Duplex",
                    price: 85000000,
                    location: "GRA Phase 2, Port Harcourt",
                    type: "For Sale",
                    image: "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=800&auto=format&fit=crop",
                    verified: true,
                    isUserListing: false,
                    advertiser: "KayCribs Realty",
                    description: "A stunning newly built duplex featuring all ensuite rooms, spacious living areas, fitted kitchen, and ample parking space. Located in a secure and serene estate."
                },
                {
                    id: 2,
                    title: "Luxury Serviced Apartment",
                    price: 3500000,
                    location: "Peter Odili Rd, PH",
                    type: "For Rent",
                    image: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=800&auto=format&fit=crop",
                    verified: true,
                    isUserListing: false,
                    advertiser: "Elite Homes",
                    description: "Fully serviced 2-bedroom apartment with 24/7 power supply, swimming pool, and gym facilities. Perfect for expatriates and executives."
                },
                {
                    id: 3,
                    title: "Commercial Office Space",
                    price: 2000000,
                    location: "Aba Road, Port Harcourt",
                    type: "For Lease",
                    image: "https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=800&auto=format&fit=crop",
                    verified: true,
                    isUserListing: false,
                    advertiser: "KayCribs Commercial",
                    description: "Open plan office space covering 150sqm. High visibility on Aba Road, perfect for banking halls or corporate headquarters."
                },
                {
                    id: 4,
                    title: "3 Plots of Dry Land",
                    price: 45000000,
                    location: "Eliozu, Port Harcourt",
                    type: "For Sale",
                    image: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=800&auto=format&fit=crop",
                    verified: true,
                    isUserListing: false,
                    advertiser: "LandWey NG",
                    description: "Fenced and gated dry land in a fast-developing area. Comes with C of O. Buy and build immediately."
                }
            ],
            chats: [
                {
                    id: 1,
                    advertiser: "KayCribs Realty",
                    messages: [
                        { sender: 'them', text: 'Hello! Are you interested in the Duplex?' },
                        { sender: 'me', text: 'Yes, is it still available?' }
                    ]
                }
            ]
        };

        // --- 3. Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderAuthUI();
            
            // Initial Route
            router.navigate('home');
        });

        // --- 4. Helper Functions (Save, Share) ---
        function saveProperty(id) {
            if (!appState.isLoggedIn) {
                alert("Please log in to save properties.");
                toggleAuthModal('buyer');
                return;
            }

            const index = appState.savedListings.indexOf(id);
            const btn = document.querySelector(`.save-btn-${id}`);
            const detailBtn = document.getElementById('detail-save-btn');

            if (index === -1) {
                appState.savedListings.push(id);
                // Update Icon to Filled
                if(btn) btn.innerHTML = `<i data-lucide="heart" class="w-5 h-5 fill-red-500 text-red-500"></i>`;
                if(detailBtn && currentPropertyId === id) {
                    detailBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5 fill-red-500 text-red-500"></i> Saved`;
                    detailBtn.classList.add('text-red-600', 'bg-red-50');
                }
                alert("Property Saved!");
            } else {
                appState.savedListings.splice(index, 1);
                // Update Icon to Outline
                if(btn) btn.innerHTML = `<i data-lucide="heart" class="w-5 h-5"></i>`;
                if(detailBtn && currentPropertyId === id) {
                    detailBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5"></i> Save`;
                    detailBtn.classList.remove('text-red-600', 'bg-red-50');
                }
            }
            localStorage.setItem('kaycribs_saved', JSON.stringify(appState.savedListings));
            lucide.createIcons();
            
            // Refresh dashboard if active
            if(router.currentPage === 'dashboard') renderDashboardListings();
        }

        function shareProperty(id) {
            const item = appState.listings.find(l => l.id === id);
            const text = `Check out this property on KayCribs: ${item.title} - ${item.location} for ₦${item.price.toLocaleString()}`;
            
            // Simulation
            alert(`Link Copied to Clipboard!\n\n"${text}"`);
        }

        // --- 5. Render Helpers ---
        function createListingCard(item) {
            const isSaved = appState.savedListings.includes(item.id);
            return `
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 group relative">
                    <div class="relative h-64 overflow-hidden">
                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        <div class="absolute top-4 left-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-gray-900 uppercase tracking-wide">
                            ${item.type}
                        </div>
                        
                        <div class="absolute top-4 right-4 flex gap-2">
                            <button onclick="shareProperty(${item.id})" class="bg-white/90 p-2 rounded-full hover:bg-white text-gray-700 transition-colors shadow-sm">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="saveProperty(${item.id})" class="save-btn-${item.id} bg-white/90 p-2 rounded-full hover:bg-white text-gray-700 transition-colors shadow-sm">
                                <i data-lucide="heart" class="w-4 h-4 ${isSaved ? 'fill-red-500 text-red-500' : ''}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-heading font-bold text-xl text-gray-900 line-clamp-1">${item.title}</h3>
                        </div>
                        <p class="text-gray-500 text-sm mb-4 flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-3 h-3"></i> ${item.location}
                        </p>
                        <div class="flex justify-between items-center pt-4 border-t border-gray-50">
                            <span class="text-green-600 font-bold text-lg">₦${item.price.toLocaleString()}</span>
                            <button onclick="openPropertyDetails(${item.id})" class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors">Details</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 6. Marketplace Logic ---
        let marketFilter = 'all';
        let marketSearch = '';

        function filterMarketplace(filter) {
            marketFilter = filter;
            // Update active button state
            document.querySelectorAll('#marketplace-filters .filter-btn').forEach(btn => {
                if(btn.dataset.filter === filter) {
                    btn.classList.add('bg-green-100', 'text-green-700');
                    btn.classList.remove('text-gray-500', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-green-100', 'text-green-700');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-100');
                }
            });
            renderMarketplaceListings();
        }

        function searchMarketplace(val) {
            marketSearch = val.toLowerCase();
            renderMarketplaceListings();
        }

        function renderMarketplaceListings() {
            const grid = document.getElementById('marketplace-grid');
            if(!grid) return;

            let filtered = appState.listings.filter(item => {
                const matchesFilter = marketFilter === 'all' || item.type === marketFilter;
                const matchesSearch = item.title.toLowerCase().includes(marketSearch) || item.location.toLowerCase().includes(marketSearch);
                return matchesFilter && matchesSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">No properties found matching your criteria.</div>`;
            } else {
                grid.innerHTML = filtered.map(item => createListingCard(item)).join('');
                lucide.createIcons();
            }
        }

        function renderHomeListings() {
            const grid = document.getElementById('home-featured-grid');
            if(grid) {
                // Show only first 3
                grid.innerHTML = appState.listings.slice(0, 3).map(item => createListingCard(item)).join('');
                lucide.createIcons();
            }
        }
        
        function renderDashboardListings() {
            const container = document.getElementById('dashboard-listings-container');
            const mainTab = document.getElementById('dashboard-tab-main');
            
            if(!container) return;

            const isBuyer = appState.user && appState.user.role === 'buyer';
            
            if(isBuyer) {
                mainTab.textContent = "Saved Properties";
                // Filter listings that are in savedListings array
                const savedItems = appState.listings.filter(l => appState.savedListings.includes(l.id));
                
                if(savedItems.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-white rounded-2xl border border-dashed border-gray-300">
                            <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="heart" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="font-bold text-gray-900 text-lg mb-2">No Saved Properties</h3>
                            <p class="text-gray-500 mb-6 max-w-sm mx-auto">Browse the marketplace and save properties you like to view them here.</p>
                            <button onclick="router.navigate('marketplace')" class="text-green-600 font-semibold hover:underline">Browse Marketplace</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${savedItems.map(item => createListingCard(item)).join('')}
                        </div>
                    `;
                }

            } else {
                // Seller View
                mainTab.textContent = "My Listings";
                const myListings = appState.listings.filter(l => l.isUserListing);
                
                if(myListings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-white rounded-2xl border border-dashed border-gray-300">
                            <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="home" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="font-bold text-gray-900 text-lg mb-2">No Properties Listed Yet</h3>
                            <p class="text-gray-500 mb-6 max-w-sm mx-auto">Start building your real estate portfolio by uploading your first property.</p>
                            <button onclick="toggleUploadModal()" class="text-green-600 font-semibold hover:underline">Upload Property</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${myListings.map(item => createListingCard(item)).join('')}
                        </div>
                    `;
                }
            }
            lucide.createIcons();
        }

        // --- 7. Chat Logic ---
        function startChat() {
            if(!appState.isLoggedIn) {
                closePropertyDetails();
                alert("Please log in as a buyer to contact the advertiser.");
                toggleAuthModal('buyer');
                return;
            }
            
            const advertiser = document.getElementById('property-details-modal').dataset.advertiser;
            
            // Check if chat exists
            let chat = appState.chats.find(c => c.advertiser === advertiser);
            if (!chat) {
                chat = {
                    id: Date.now(),
                    advertiser: advertiser,
                    messages: []
                };
                appState.chats.push(chat);
            }
            
            closePropertyDetails();
            router.navigate('chat');
            loadChat(chat.id);
        }

        function renderChatList() {
            const list = document.getElementById('chat-list');
            if(!list) return;

            if (appState.chats.length === 0) {
                list.innerHTML = `<div class="p-4 text-gray-500 text-center text-sm">No conversations yet.</div>`;
                return;
            }

            list.innerHTML = appState.chats.map(chat => `
                <div onclick="loadChat(${chat.id})" class="chat-sidebar-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${activeChatId === chat.id ? 'active' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold">
                            ${chat.advertiser.charAt(0)}
                        </div>
                        <div>
                            <h4 class="font-bold text-sm text-gray-900">${chat.advertiser}</h4>
                            <p class="text-xs text-gray-500 truncate w-32">
                                ${chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].text : 'No messages'}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadChat(chatId) {
            activeChatId = chatId;
            const chat = appState.chats.find(c => c.id === chatId);
            
            // Update Sidebar Active State
            renderChatList();

            // Setup Main Area
            document.getElementById('chat-header-avatar').innerText = chat.advertiser.charAt(0);
            document.getElementById('chat-header-name').innerText = chat.advertiser;
            document.getElementById('chat-header-status').innerText = "Online";
            document.getElementById('chat-input-area').classList.remove('hidden');

            const msgContainer = document.getElementById('chat-messages');
            msgContainer.innerHTML = '';

            if (chat.messages.length === 0) {
                msgContainer.innerHTML = `<div class="text-center text-gray-400 text-sm mt-10">Start a conversation with ${chat.advertiser}</div>`;
            } else {
                chat.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `flex w-full mb-4`;
                    div.innerHTML = `
                        <div class="message-bubble ${msg.sender === 'me' ? 'message-sent' : 'message-received'}">
                            ${msg.text}
                        </div>
                    `;
                    msgContainer.appendChild(div);
                });
            }
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        function handleSendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !activeChatId) return;

            const chat = appState.chats.find(c => c.id === activeChatId);
            chat.messages.push({ sender: 'me', text: text });
            
            input.value = '';
            loadChat(activeChatId);

            // Simulate Reply
            setTimeout(() => {
                chat.messages.push({ sender: 'them', text: "Thanks for your interest! When would you like to view the property?" });
                loadChat(activeChatId);
            }, 1500);
        }

        // --- 8. Auth & Modal Logic ---
        function toggleAuthModal(initialRole) {
            const modal = document.getElementById('auth-modal');
            modal.classList.toggle('active');
            if(initialRole) {
                setAuthRole(initialRole);
                switchAuthMode('signup');
            } else {
                switchAuthMode('login');
            }
        }

        function switchAuthMode(mode) {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            
            if (mode === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        function setAuthRole(role) {
            currentAuthRole = role;
            document.getElementById('btn-role-buyer').className = role === 'buyer' ? 'auth-toggle-btn active' : 'auth-toggle-btn inactive';
            document.getElementById('btn-role-seller').className = role === 'seller' ? 'auth-toggle-btn active' : 'auth-toggle-btn inactive';
            document.getElementById('login-title').innerText = role === 'buyer' ? 'Buyer Login' : 'Seller Login';
            document.getElementById('signup-title').innerText = role === 'buyer' ? 'Create Buyer Account' : 'Partner Sign Up';
            const idField = document.getElementById('id-verification-field');
            if(role === 'seller') {
                idField.classList.remove('hidden');
                document.getElementById('signup-id-input').required = true;
            } else {
                idField.classList.add('hidden');
                document.getElementById('signup-id-input').required = false;
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Signing in...";
            btn.disabled = true;

            setTimeout(() => {
                appState.isLoggedIn = true;
                appState.user = { name: "User", email: "user@example.com", role: currentAuthRole };
                localStorage.setItem('kaycribs_logged_in', 'true');
                localStorage.setItem('kaycribs_user', JSON.stringify(appState.user));
                
                toggleAuthModal();
                renderAuthUI();
                router.navigate('dashboard');
                
                btn.innerText = originalText;
                btn.disabled = false;
            }, 800);
        }

        function handleSignup(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = currentAuthRole === 'seller' ? "Verifying Identity..." : "Creating Account...";
            btn.disabled = true;

            setTimeout(() => {
                appState.isLoggedIn = true;
                appState.user = { name: "New User", email: "new@example.com", role: currentAuthRole, verified: currentAuthRole === 'seller' };
                localStorage.setItem('kaycribs_logged_in', 'true');
                localStorage.setItem('kaycribs_user', JSON.stringify(appState.user));
                
                toggleAuthModal();
                renderAuthUI();
                router.navigate('dashboard');
                
                if(currentAuthRole === 'seller') {
                    alert("Identity Verified! Partner account created successfully.");
                } else {
                    alert("Account created successfully.");
                }
                
                btn.innerText = originalText;
                btn.disabled = false;
            }, 1500);
        }

        function logout() {
            appState.isLoggedIn = false;
            appState.user = null;
            localStorage.removeItem('kaycribs_logged_in');
            localStorage.removeItem('kaycribs_user');
            renderAuthUI();
            router.navigate('home');
        }

        function renderAuthUI() {
            const desktopAuth = document.getElementById('auth-buttons-desktop');
            const mobileAuth = document.getElementById('auth-buttons-mobile');
            const heroBtns = document.querySelectorAll('.hero-auth-btn');
            const sellerActions = document.getElementById('seller-actions');
            const mobileChatLink = document.querySelector('.mobile-chat-link');

            if (appState.isLoggedIn) {
                // Logged In View
                desktopAuth.innerHTML = `
                    <div class="flex items-center gap-3">
                        <button onclick="router.navigate('chat')" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 text-gray-600 transition-colors">
                            <i data-lucide="message-square" class="w-5 h-5"></i>
                        </button>
                        <button onclick="router.navigate('dashboard')" class="text-sm font-medium text-gray-700 hover:text-green-600">Dashboard</button>
                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold">
                            ${appState.user.name.charAt(0)}
                        </div>
                        <button onclick="logout()" class="text-sm font-medium text-gray-500 hover:text-red-600">Logout</button>
                    </div>
                `;
                mobileAuth.innerHTML = `
                    <button onclick="router.navigate('dashboard'); toggleMobileMenu()" class="text-left text-gray-700 font-medium hover:text-green-600">My Dashboard</button>
                    <button onclick="logout(); toggleMobileMenu()" class="text-left text-red-600 font-medium">Logout</button>
                `;
                
                if(mobileChatLink) mobileChatLink.classList.remove('hidden');
                document.querySelectorAll('.user-name-display').forEach(el => el.innerText = appState.user.name);
                
                heroBtns.forEach(btn => {
                    btn.innerText = "Go to Dashboard";
                    btn.onclick = () => router.navigate('dashboard');
                });
                
                if(sellerActions) {
                    if(appState.user.role === 'seller') {
                        sellerActions.classList.remove('hidden');
                    } else {
                        sellerActions.classList.add('hidden');
                    }
                }

            } else {
                // Logged Out View
                desktopAuth.innerHTML = `
                    <button onclick="toggleAuthModal()" class="text-sm font-medium text-gray-600 hover:text-green-600">Login</button>
                    <button onclick="toggleAuthModal('buyer')" class="px-4 py-2 text-sm font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition-shadow shadow-md shadow-green-600/20">Get Started</button>
                `;
                mobileAuth.innerHTML = `
                    <button onclick="toggleAuthModal()" class="text-left text-gray-700 font-medium">Login</button>
                    <button onclick="toggleAuthModal('buyer')" class="text-left text-green-600 font-medium">Create Account</button>
                `;
                
                if(mobileChatLink) mobileChatLink.classList.add('hidden');
                heroBtns.forEach(btn => {
                    btn.innerText = "Create Account";
                    btn.onclick = () => toggleAuthModal('buyer');
                });
                
                if(sellerActions) sellerActions.classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- 9. Property Logic (Details & Upload) ---
        function openPropertyDetails(id) {
            const listing = appState.listings.find(l => l.id === id);
            if(!listing) return;

            currentPropertyId = id; // Set global current ID for save/share

            document.getElementById('detail-image').src = listing.image;
            document.getElementById('detail-type').innerText = listing.type;
            document.getElementById('detail-title').innerText = listing.title;
            document.getElementById('detail-location').innerText = listing.location;
            document.getElementById('detail-price').innerText = '₦' + listing.price.toLocaleString();
            document.getElementById('detail-desc').innerText = listing.description || "No specific comments provided by the advertiser.";
            
            document.getElementById('advertiser-name').innerText = listing.advertiser || "Verified User";
            document.getElementById('advertiser-avatar').innerText = (listing.advertiser || "U").charAt(0);

            document.getElementById('property-details-modal').dataset.advertiser = listing.advertiser || "Agent";

            // Update Save Button State in Modal
            const detailSaveBtn = document.getElementById('detail-save-btn');
            if(appState.savedListings.includes(id)) {
                detailSaveBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5 fill-red-500 text-red-500"></i> Saved`;
                detailSaveBtn.classList.add('text-red-600', 'bg-red-50');
            } else {
                detailSaveBtn.innerHTML = `<i data-lucide="heart" class="w-5 h-5"></i> Save`;
                detailSaveBtn.classList.remove('text-red-600', 'bg-red-50');
            }

            const modal = document.getElementById('property-details-modal');
            modal.classList.add('active');
            lucide.createIcons();
        }

        function closePropertyDetails() {
            const modal = document.getElementById('property-details-modal');
            modal.classList.remove('active');
        }

        function toggleUploadModal() {
            const modal = document.getElementById('upload-modal');
            modal.classList.toggle('active');
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const container = document.getElementById('image-preview-container');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    container.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handlePropertyUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('property-image');
            const reader = new FileReader();

            reader.onload = function(event) {
                const newProperty = {
                    id: Date.now(),
                    title: document.getElementById('prop-title').value,
                    price: parseInt(document.getElementById('prop-price').value),
                    location: document.getElementById('prop-location').value,
                    type: document.getElementById('prop-type').value,
                    image: event.target.result,
                    verified: false,
                    isUserListing: true,
                    advertiser: appState.user.name,
                    description: document.getElementById('prop-desc').value
                };

                appState.listings.unshift(newProperty);
                
                if(router.currentPage === 'dashboard') renderDashboardListings();
                if(router.currentPage === 'home') renderHomeListings();
                if(router.currentPage === 'marketplace') renderMarketplaceListings();
                
                toggleUploadModal();
                e.target.reset();
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('image-preview-container').classList.remove('hidden');
                
                alert("Property uploaded successfully to your Dashboard!");
            };

            if (fileInput.files[0]) {
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        // Mobile Menu Helper
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</body>
</html>